<html>

<head>
  <title>Annotation data collector</title>
  <style>
    label:has(input[required])::before {
      content: " *";
      color: red;
      font-weight: bold;
    }

    .required::before {
      content: " *";
      color: red;
      font-weight: bold;
    }

    :root {
      --primary: #2563eb;
      /* blue-600 */
      --primary-dark: #1e40af;
      --bg: #f8fafc;
      /* slate-50 */
      --card: #ffffff;
      --text: #0f172a;
      /* slate-900 */
      --muted: #64748b;
      /* slate-500 */
      --border: #e2e8f0;
      /* slate-200 */
      --success: #16a34a;
      --error: #dc2626;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
        Roboto, Ubuntu, Cantarell, "Helvetica Neue", Arial, sans-serif;
      background: var(--bg);
      color: var(--text);
      line-height: 1.5;
    }

    #app {
      max-width: 920px;
      margin: 24px auto;
      padding: 0 16px;
    }

    form {
      background: var(--card);
      border-radius: 12px;
      padding: 24px;
      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.06);
    }

    h1 {
      margin-top: 0;
      font-size: 1.6rem;
      border-bottom: 1px solid var(--border);
      padding-bottom: 12px;
    }

    h2,
    h3 {
      margin-top: 24px;
      font-size: 1.2rem;
      color: var(--primary-dark);
    }

    p {
      margin: 0 0 16px;
    }

    label {
      font-weight: 600;
      display: block;
      margin-bottom: 6px;
    }

    input,
    select,
    textarea {
      width: 100%;
      padding: 10px 12px;
      border-radius: 8px;
      border: 1px solid var(--border);
      font-size: 0.95rem;
      background: white;
    }

    input:focus,
    textarea:focus,
    select:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 2px rgba(37, 99, 235, 0.15);
    }

    input[type="radio"],
    input[type="checkbox"] {
      width: auto;
      margin-right: 6px;
    }

    .field-group {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 16px;
    }

    button {
      background: var(--primary);
      color: white;
      border: none;
      padding: 12px 18px;
      border-radius: 10px;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: background 0.2s, transform 0.1s;
    }

    button:hover {
      background: var(--primary-dark);
    }

    button:active {
      transform: scale(0.98);
    }

    button.secondary {
      background: #e5e7eb;
      color: var(--text);
    }

    button.secondary:hover {
      background: #d1d5db;
    }

    .status-success {
      color: var(--success);
      font-weight: 600;
    }

    .status-error {
      color: var(--error);
      font-weight: 600;
    }

    #map {
      border-radius: 12px;
      border: 1px solid var(--border);
      overflow: hidden;
    }

    .accuracy-badge {
      display: inline-block;
      background: #e0f2fe;
      color: #0369a1;
      padding: 4px 10px;
      border-radius: 999px;
      font-size: 0.8rem;
      margin-top: 6px;
    }
  </style>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

</head>

</html>
<div id="app">
  <form @submit.prevent="submitForm">
    <h1>Map Data</h1>

    <p v-if="error" style="color:red">{{ error }}</p>
    <p v-if="success" style="color:green">{{ success }}</p>

    <p>
      <label for="username">Username:
        <input type="text" v-model="username" id="username" name="username" required>
      </label>
    </p>

    <p>
      <label for="building_id">Building id:
        <input type="text" v-model="building_id" id="building_id" required>
      </label>
    </p>

    <p>
      Street name
      <input type="text" v-model="street_name" />
    </p>

    <p>
      <label for="front_elevation">Front Elevation:
        <input type="file" id="front_elevation" @change="onFileChange" required />
      </label>
    </p>

    <p>
    <h2>Geo Coordinates:</h2>
    <div class="field-group">
      <div>
        <label class="required">Latitude</label>
        <input type="number" v-model="latitude" step="any" required />
      </div>

      <div>
        <label class="required">Longitude</label>
        <input type="number" v-model="longitude" step="any" required />
      </div>

      <div>
        <label>Altitude (m)</label>
        <input type="number" v-model="altitude" step="any" />
      </div>

      <div>
        <label>Accuracy (m)</label>
        <input type="number" v-model="accuracy" step="any" />
      </div>
    </div>

    <h3>Pick location on map</h3>
    <div id="map" style="height: 350px; width: 100%; margin-bottom: 10px;"></div>

    <div style="display:flex; gap:12px; margin-bottom:12px;">
      <button type="button" class="secondary" @click="getCurrentLocation">
        üìç Use current location
      </button>
    </div>


    </p>

    <p>
      <label id="date_time">Date and Time
        <input type="datetime-local" v-model="date_time" id="date_time" required>
      </label>
    </p>
    <p>
      <label id="level" class="required">Ground or Stilt
        <p v-for="levelData in levelDatas" :key="levelData" v-if="!loading && !error">
          <input type="radio" :value="levelData" v-model="selectedLevel" required />
          {{levelData}}
        </p>
      </label>
    </p>
    <p>
      <label for="other_level">If other - Mention it
        <input type="text" v-model="other_level" id="other_level">
      </label>
    </p>
    <p>
      <label for="no_of_storeys">No. of Storey(Excluding Ground or Stilt)
        <input type="number" v-model="no_of_storeys" id="no_of_storeys" required>
      </label>
    </p>
    <p>
      <label id="use" class="required">Building Use
        <p v-for="use in buildingUse" :key="use" v-if="!loading && !error">
          <input type="checkbox" :value="use" v-model="selectedBuilding" />
          {{use}}
        </p>
      </label>
    </p>
    <p>
      <label for="multiple_spec">If selected multiple options, give specifications
        <input type="text" v-model="multiple_spec" id="multiple_spec" />
      </label>
    </p>

    <p>
      <label id="structure" class="required">Structure type
        <p v-for="struct in structure" :key="struct" v-if="!loading && !error">
          <input type="radio" :value="struct" v-model="selectedStructure" required />
          {{struct}}
        </p>
      </label>
    </p>

    <p>
      <label for="other_structure">If selected others, Specify
        <input type="text" v-model="other_structure" id="other_structure" />
      </label>
    </p>

    <p>
      <label for="age">Age of the building
        <input type="number" v-model="age" id="age" required>
      </label>
    </p>

    <p>
      <label for="age_analysis">How did you arrive at the age, specify
        <input type="text" v-model="age_analysis" id="age_analysis">
      </label>
    </p>

    <p>
      <label id="visual" class="required">Visual analysis of the building materials used
        <p v-for="vis in visual" :key="vis" v-if="!loading && !error">
          <input type="checkbox" :value="vis" v-model="selectedVisual" />
          {{vis}}
        </p>
      </label>
    </p>
    <p>
      <label for="other_visual_analysis">If other - Mention it
        <input type="text" v-model="other_visual_analysis" id="other_visual_analysis">
      </label>
    </p>


    <button type="submit">Submit</button>

  </form>
</div>

<script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
<script src="https://unpkg.com/axios/dist/axios.min.js"></script>
<script>
  const app = Vue.createApp({
    data() {
      return {
        levelDatas: [],
        selectedLevel: "",
        buildingUse: [],
        selectedBuilding: [],
        structure: [],
        selectedStructure: "",
        visual: [],
        selectedVisual: [],
        username: "",
        building_id: "",
        street_name: "",
        front_elevation: null,
        latitude: null,
        longitude: null,
        altitude: 0,
        accuracy: null,
        map: null,
        marker: null,
        geo_coordinate: { latitude: 0, longitude: 0, altitude: 0, accuracy: 0 },
        date_time: "",
        other_level: "",
        no_of_storeys: 0,
        use: "",
        multiple_spec: "",
        other_structure: "",
        age_analysis: "",
        age: 0,
        other_visual_analysis: "",
        loading: false,
        success: "",
        error: ""
      };
    },
    mounted() {
      this.initMap();
      this.setCurrentDateTime();
    },

    created() {
      this.fetchCategories("level", "levelDatas");
      this.fetchCategories("use", "buildingUse");
      this.fetchCategories("structre", "structure");
      this.fetchCategories("visual", "visual");
    },
    methods: {
      initMap() {
        // Default location (India center)
        const defaultLat = 20.5937;
        const defaultLng = 78.9629;

        this.map = L.map("map").setView([defaultLat, defaultLng], 5);

        L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
          attribution: "¬© OpenStreetMap contributors"
        }).addTo(this.map);

        // Click to select location
        this.map.on("click", (e) => {
          this.setMarker(e.latlng.lat, e.latlng.lng);
        });
      },
      setCurrentDateTime() {
        const now = new Date();

        const pad = (n) => n.toString().padStart(2, "0");

        const formatted =
          now.getFullYear() + "-" +
          pad(now.getMonth() + 1) + "-" +
          pad(now.getDate()) + "T" +
          pad(now.getHours()) + ":" +
          pad(now.getMinutes());

        this.date_time = formatted;
      },
      setMarker(lat, lng) {
        this.latitude = lat;
        this.longitude = lng;

        if (this.marker) {
          this.marker.setLatLng([lat, lng]);
        } else {
          this.marker = L.marker([lat, lng]).addTo(this.map);
        }
      },

      getCurrentLocation() {
        if (!navigator.geolocation) {
          alert("Geolocation not supported");
          return;
        }

        navigator.geolocation.getCurrentPosition(
          (position) => {
            const { latitude, longitude, accuracy, altitude } = position.coords;

            this.latitude = latitude;
            this.longitude = longitude;
            this.accuracy = accuracy;
            this.altitude = altitude || 0;

            this.map.setView([latitude, longitude], 18);
            this.setMarker(latitude, longitude);
          },
          (err) => {
            alert("Location permission denied or unavailable");
            console.error(err);
          },
          {
            enableHighAccuracy: true,
            timeout: 10000
          }
        );
      },
      fetchCategories(link, variable) {
        this.loading = true;
        const apiUrl = "/" + link;

        axios.get(apiUrl).then(response => {
          this[variable] = response.data
          this.loading = false;
        })
          .catch(error => {
            console.error("Error fetching data", error);
            this.error = "Failed to load categories:" + link;
            this.loading = false
          })
      },
      onFileChange(event) {
        this.front_elevation = event.target.files[0];
      },
      async updateLater() {
        await new Promise(r => setTimeout(r, 5000));
        this.success = "",
          this.error = ""
      },
      reset() {
        this.levelDatas = [],
        this.selectedLevel = "",
        this.buildingUse = [],
        this.selectedBuilding = [],
        this.structure = [],
        this.selectedStructure = "",
        this.visual = [],
        this.selectedVisual = [],
        this.username = "",
        this.building_id = "",
        this.street_name = "",
        this.front_elevation = null,
        this.geo_coordinate = { latitude: 0, longitude: 0, altitude: 0, accuracy: 0 },
        this.latitude = latitude,
        this.longitude = longitude,
        this.altitude = altitude,
        this.accuracy = accuracy,
        this.date_time = "",
        this.other_level = "",
        this.no_of_storeys = 0,
        this.use = "",
        this.multiple_spec = "",
        this.other_structure = "",
        this.age_analysis = "",
        this.age = 0,
        this.other_visual_analysis = "",
        this.loading = false,
        this.fetchCategories("level", "levelDatas");
        this.fetchCategories("use", "buildingUse");
        this.fetchCategories("structre", "structure");
        this.fetchCategories("visual", "visual");
        this.updateLater();
        this.initMap();
        this.setCurrentDateTime();
      },
      async submitForm() {
        this.success = "";
        this.error = "";

        try {
          const formData = new FormData();

          // JSON payload (must match FastAPI model exactly)
          const annotationData = {
            username: this.username,
            building_id: this.building_id,
            street_name: this.street_name,
            geo_coordinate: {
              latitude: this.latitude,
              longitude: this.longitude,
              altitude: this.altitude,
              accuracy: this.accuracy
            },
            date_time: this.date_time,
            level: this.selectedLevel,
            other_level: this.other_level,
            no_of_storeys: this.no_of_storeys,
            use: this.selectedBuilding,
            multiple_spec: this.multiple_spec,
            structure_type: this.selectedStructure,
            other_structure: this.other_structure,
            age_analysis: this.age_analysis,
            age: this.age,
            visual_analysis: this.selectedVisual,
            other_visual_analysis: this.other_visual_analysis
          };
          //append json as string
          formData.append("data", JSON.stringify(annotationData));

          // Append file
          formData.append("image", this.front_elevation);

          const res = await fetch("/map_data", {
            method: "POST",
            body: formData
          });

          if (!res.ok) {
            const text = await res.text();
            throw new Error(text || `Request failed (${res.status})`);
          }

          this.success = "Submitted successfully!";
        } catch (err) {
          console.error(err);
          this.error = err.message || "Upload failed";
        }
        this.reset();
      }
    }
  });

  app.mount("#app");
</script>